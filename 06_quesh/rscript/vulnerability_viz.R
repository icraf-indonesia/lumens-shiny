#combine erosion and aridity data
library(ggplot2)
library(ggpointdensity)
library(viridis)
library(tidyterra)
library(terra)
library(dplyr)
library(tidyverse)

area<-"sulsel"

#lc normalized
lc_legend_val<- read_csv(paste0("data/",area,"/tabular/lc_legend_val.csv"))
lc_factor <- as.factor(lc) 
is.factor(lc_factor)
lc_factor_t <- levels(lc_factor)
lc_factor_t <- merge(x = lc_factor_t, y = lc_legend_val, by="ID", all.x = TRUE)
levels(lc_factor) <- lc_factor_t
lc_val <- catalyze(lc_factor) |> 
  project(area_ext)

erosion_norm_rast<-rast(paste0("result/",area,"/erosion_norm.tiff"))
AI_norm_rast<-rast(paste0("result/",area,"/AI_norm.tiff"))
lc_val_norm<-normalized_raster(lc_val[[3]])
raster_files<-c(erosion_norm,AI_norm,lc_val_norm)
raster_files_df<-as.data.frame(raster_files) |> na.omit()

# loop through each raster file
for (i in 1:length(raster_files)) {
  # read in the raster file
  r <- rast(raster_files[i])
  # add the raster to the list
  raster_list[[i]] <- r
}
# erosion_norm_<-crop(AI_norm,erosion_norm)
# combine<-merge(erosion_norm,AI_norm)


erosion_norm_df <- as.data.frame(erosion_norm, xy = TRUE) 
AI_norm_df <- as.data.frame(AI_norm, xy = TRUE)
lc_val_df <- as.data.frame(lc_val_norm, xy = TRUE)
heatmap_df <- merge(erosion_norm_df, AI_norm_df) |> 
  merge(lc_val_df)
heatmap_map<-c(lc_val_norm, AI_norm, erosion_norm)
heatmap_map_mean<-mean(c(lc_val_norm, AI_norm, erosion_norm))
plot(heatmap_map)

#pca analysis
heatmap_pca<-rasterPCA(heatmap_map)

#plot the data (max 3 vars)
heatmap_sample <- sample_frac(heatmap_df, 0.01)
ggplot(heatmap_sample, aes(x=mean, y=sum, color = value)) + 
  geom_tile() +
  labs(x = "AI", y = "erosion", color = "land cover") +
  scale_color_gradient(trans = "log10") +
  theme_bw() +
  scale_y_log10() +
  geom_pointdensity() +
  scale_color_viridis() +
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1))


