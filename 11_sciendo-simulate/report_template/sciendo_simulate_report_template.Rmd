---
title: "SCIENDO-Simulate Report"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: united
    highlight: tango
    df_print: kable
params:
  start_time: NA
  end_time: NA
  inputs: NA
  session_log: NA  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load function, include=FALSE, error=TRUE, warning=TRUE, message=TRUE}
source("../rscript/function_sciendo_simulate.R")
```

```{r load_library, include=FALSE}
library(raster)
library(dplyr)
library(DT)
library(kableExtra)
library(htmltools)
library(terra)
library(tidyterra)
library(ggplot2)
library(LUMENSR)
```

<details>

<summary>Click here for Analysis Log</summary>

```{r analysis-log, echo=FALSE}
analysis_log <- tribble(
  ~Category,                       ~Details,
  "Analysis Start",                params$start_time,
  "Analysis End",                  params$end_time,
  "Input Data and Parameters",     "",
  "1. Landcover map initial",      params$inputs$lc_t1_path,
  "2. Planning unit",              params$inputs$zone_path,
  "3. Land cover lookup table",    params$inputs$lc_lookup_table_path,
  "4. Raster cube",                params$inputs$ers_path,
  "5. Transition matrix directory",params$inputs$tm_path,
  "6. WoE directory",              params$inputs$dcf_path,
  "Output Workspace",              params$inputs$output_dir,
  "1. Land use/cover projection maps",               paste0(params$inputs$output_dir, '/landscape.tif'),
  "2. Land use/cover change lookup table",         paste0(params$inputs$output_dir, '/luc_projection.csv'),
  "3. EGOML Simulation",         paste0(params$inputs$output_dir, '/03_sciendo_simulation.egoml'),
  "Session Summary",               ""
) %>% rbind(params$session_log)

analysis_log %>% kbl(caption = "Analysis Log", escape = FALSE) %>%
  kable_paper("hover", full_width = F )
```

</details>

# Summary

Land use change simulation results are based on the `r params$inputs$rep` iteration input and save as raster map (GeoTIFF) with the unique name `landscape{n-th}.tif`.

# Module brief description

- SCIENDO-Simulate predicts how land use will change in the future based on the training data that is done using SCIENDO-Train where land use/cover at T1 and T2, transition probability matrix and factor maps as explanatory variables like distance maps, climate variables, etc was taking into account.     

- Land use/cover change lookup table provides a comprehensive overview of how land use and land cover categories have transformed across all the projected years of a study

# Input data {.tabset}

## Land-Use/Cover Map Initial

```{r Land-Use/Cover Map T1, echo=FALSE, message=FALSE, warning=FALSE}
df_lc <- read.csv(params$inputs$lc_lookup_table_path)
#=Load landuse for two time periods
lc_t1 <- params$inputs$lc_t1_path %>% rast() %>%
  add_legend_to_categorical_raster(., lookup_table = df_lc)
plot_categorical_raster(lc_t1)
```

## Planning Unit

```{r planning unit, echo=FALSE, message=FALSE, warning=FALSE}
params$inputs$zone_path %>% rast() %>% plot()
```


## Land-Use/Cover Lookup Table

```{r lut, echo=FALSE, message=FALSE, warning=FALSE}
df_lc %>% kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

# Results

## Land Use/Cover Change Projection Maps {.tabset}

```{r lu projected maps, echo=FALSE, fig.keep='all', results='asis'}
list_luc <- params$inputs$output_dir %>% 
  list.files(full.names=TRUE, pattern="*.tif$")
rst_list <- list()
counter <- 0
for(i in list_luc){
  r <- i %>% rast() %>%
    add_legend_to_categorical_raster(., lookup_table = df_lc)
  rst_list[[i]] <- r
  counter <- counter + 1
  
  cat(paste0("### Projected land cover at T+", counter, " \n\n"))
  cat(
    knitr::knit_child(
      text = c(
        "```{r}",
        "#| echo: false",
        "#| message: false",
        "#| warning: false",
        "r %>% plot_categorical_raster()",
        "```"
      ), quiet = TRUE
    ), sep = "\n"
  )
  
  cat('\n')
  
}
```

## Land Use/Cover Change Lookup Table

```{r lut change, echo=FALSE, message=FALSE, warning=FALSE}
all_freq <- calc_lc_freq(raster_list = rst_list) %>%
    abbreviate_by_column("Jenis tutupan lahan", remove_vowels = FALSE) 
colnames(all_freq) <- c("LC", paste0("T+", 1:(ncol(all_freq)-1)))

if (grepl("\\+units=m", st_crs(lc_t1)$proj4string)) {
  spatRes <- calc_res_conv_factor_to_ha(lc_t1)
  lc_freq_table <-
    mutate(all_freq, across(c(2:ncol(all_freq)), ~(spatRes*.x))) %>% 
    mutate(across(c(2:ncol(all_freq)), ~units::set_units(x = .x, value = "ha")))
  
  all_freq <- mutate(all_freq, across(c(2:ncol(all_freq)), ~(spatRes*.x)))
} else {
  cat("Frequency is shown in number of pixels instead of hectares in the lc_freq_table")
}

df_merge <- df_lc[, 1:2] %>% dplyr::rename(ID = 1, LC = 2)
lc_freq_table <- lc_freq_table %>% 
  dplyr::left_join(df_merge, by = "LC") %>%
  dplyr::arrange(ID) %>%
  dplyr::relocate(ID, .before = LC)
lc_freq_table %>% kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
all_freq <- all_freq %>% 
  dplyr::left_join(df_merge, by = "LC") %>%
  dplyr::arrange(ID) %>%
  dplyr::relocate(ID, .before = LC)
write.table(all_freq,
  paste0(params$inputs$output_dir, "/luc_projection.csv"), 
  quote=FALSE, 
  row.names=FALSE, 
  sep=","
)
```


------------------------------------------------------------------------

<!-- Mandatory closing statement for all module -->

<font size="1"> LUMENS is free software and comes with ABSOLUTELY NO WARRANTY. Users are responsible for the results generated. Results depend on the quality of the input data ("garbage in, garbage out") and may vary or be sensitive to the parameters used. Please report any problems encountered while using LUMENS as [a GitHub issue](https://github.com/icraf-indonesia/lumens-shiny/issues). Feedback and questions are welcome [Contact Us URL]. </font size>