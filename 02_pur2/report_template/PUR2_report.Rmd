---
title: "Planning Unit Reconciliation (Reconcile) Report"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
params:
  session_log: NA
  start_time: NA
  end_time: NA
  output_dir: NA
  summary_PUR: NA
  total_area: NA
  sa: NA
  unresolved_shp_path: NA
  unresolved_table_path: NA
  recon_result_shp_path: NA
  recon_result_table_path: NA
  recon_result_shp_dis_path: NA
  recon_result_raster_path: NA
  final_lookup_table_path: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r load library, include=FALSE}
# source("02_pur2/rscript/global.r")
check_and_install_packages(
  c(
    "knitr",
    "kableExtra",
    "dplyr",
    "ggplot2",
    "sf",
    "terra",
    "dplyr",
    "DT",
    "units",
    "ggspatial",
    "RColorBrewer",
    "cowplot"
  )
)
```

<details><summary>Click here for Analysis Log</summary>

```{r analysis-log, echo=FALSE}

analysis_log <- tribble(
  ~Category, ~Details,
  "Analysis Start", params$start_time,
  "Analysis End", params$end_time,
  "Input Data and Parameters", "",
  "1. Unresolved Planning Unit Map", params$unresolved_shp_path,
  "2. Unresolved Attribute Table", params$unresolved_table_path,
  "Output Files", "",
  "Output workspace", paste0(getwd(), params$output_dir),
  "1. Reconciliation Result Map (Shapefile)", file.path(params$output_dir, params$recon_result_shp_path),   
  "2. Reconciliation Result Table", file.path(params$output_dir, params$recon_result_table_path),
  "3. Reconciliation Result Map (Dissolved)", file.path(params$output_dir, params$recon_result_shp_dis_path),
  "4. Reconciliation Result Map (Raster)", file.path(params$output_dir, params$recon_result_raster_path),
  "5. Final Result Table", file.path(params$output_dir, params$final_lookup_table_path),
  "Session Summary", "",
) %>% rbind(format_session_info_table())

analysis_log %>% kbl(caption = "Analysis Log", escape = FALSE) %>%
  kable_paper("hover", full_width = F )
```

</details>

## Summary

The total area analyzed was `r format(round(params$total_area, 2), big.mark = ",")` hectares. This report displays the resolved reconciled area of the overlapping zone identified from the PUR Build Module.

## Module brief description

Planning unit reconciliation is a process to resolve overlapping permits by referring to function reference maps. Reconciliation is done by analyzing how well the permit data matches the reference data. Permit data can include things like forest management concessions, plantation permits, mining permits, and others. Reference data can be spatial planning data or area designation data.

## Results

### Reconciliation Results Map
```{r Reconciliation Result Map, echo=FALSE}
n_colors <- length(unique(params$sa$Rec_phase2))
colors <- brewer.pal(n = min(n_colors, 12), name = "Set3")
if (n_colors > 12) {
  colors <- colorRampPalette(colors)(n_colors)
}

# Create the main plot
main_plot <- ggplot() +
  geom_sf(data = params$sa, aes(fill = Rec_phase2), color = "white", size = 0.1) +
  scale_fill_manual(values = colors, name = NULL) + 
  theme_minimal() +
  theme(
    axis.text = element_text(size = 8),
    panel.grid = element_line(color = "grey90", size = 0.2),
    panel.background = element_rect(fill = "white"),
    legend.position = "right",
    legend.key.size = unit(0.5, "cm"),
    legend.text = element_text(size = 8),
    plot.margin = margin(10, 10, 10, 10)
  ) +
  coord_sf(expand = FALSE) +
  guides(fill = guide_legend(ncol = 1, byrow = TRUE))

legend <- get_legend(main_plot)
main_plot <- main_plot + theme(legend.position = "none")

combined_plot <- plot_grid(
  main_plot, legend,
  rel_widths = c(0.7, 0.3),
  nrow = 1
)

knitr::knit_print(combined_plot)
```

### Reconciliation Data Summary

The table below summarizes the final reconciliation results:

```{r Reconsiliation Result Table, echo=FALSE}

table_recon <- params$summary_PUR
table_recon <- table_recon %>%
  mutate(Area = as.numeric(units::set_units(Area, "ha")),
         Area = round(Area, 0))
total_area <- sum(table_recon$Area, na.rm = TRUE)
table_recon <- table_recon %>%
  mutate(Percentage = round(Area / total_area * 100, 2))

# Define the pastel color palette
n_colors <- length(unique(table_recon$Rec_phase2))
colors <- brewer.pal(n = min(n_colors, 12), name = "Set3")
if (n_colors > 12) {
  colors <- colorRampPalette(colors)(n_colors)
}

# Create a doughnut chart with pastel color palette
pie_chart <- ggplot(table_recon, aes(x = 2, y = Percentage, fill = Rec_phase2)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  theme_void() +
  xlim(0.5, 2.5) +  
  geom_text(aes(label = paste0(round(Percentage, 2),"%")), 
            position = position_stack(vjust = 0.5)) +  
  scale_fill_manual(values = colors) + 
  labs(fill = "Reconciliation Class") +
  ggtitle("Distribution of Reconciled Areas") +
  theme(legend.position = "right")

print(pie_chart)

# Create the datatable
DT::datatable(table_recon, 
              colnames = c("ID", "Final Resolved Area", "Area (Ha)", "Percentage (%)"),
              options = list(pageLength = 10, scrollX = TRUE)) %>%
  formatStyle(columns = names(table_recon), fontSize = '90%') %>%
  formatRound(columns = "Area", digits = 0) %>%
  formatRound(columns = "Percentage", digits = 2)
```