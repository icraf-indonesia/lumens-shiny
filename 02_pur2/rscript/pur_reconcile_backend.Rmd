---
title: "pur_reconcile_backend"
author: "Faza"
date: "2024-08-23"
format: html
editor: source
---

## 1. Load Library

```{r}
#=Load library
library(raster)
library(dplyr)
library(sf)
library(terra)

time_start<-paste(eval(parse(text=(paste("Sys.time ()")))), sep="")
```

## 2. Input Data and Directories

```{r}
ref_data <- "data/pur_test/RTRW_V2Fcr_Raster.tif"
#recon_file = rgdal::readOGR("data/pur_test/",layer="PURrec1shp")
unresolved_table="data/pur_test/unresolved_table.csv"
inputPU1_dir="01_pur1/output/"
output_dir="02_pur2/output/"

ref <- raster(ref_data)
recon_file = rgdal::readOGR(paste0(inputPU1_dir),layer="PUR_reconciliation_result")
```

## 3. Load and Process Attribute Table

```{r}
attribute_dir <- paste0(inputPU1_dir, "PUR_attribute.csv")
attribute <- read.table(attribute_dir, header = TRUE, sep = ",")
last_unresolved <- max(which(attribute$Rec_phase1b == "unresolved_case"))
attribute <- attribute[1:last_unresolved, ]
```

### 3.a Load unresolved cases and join with attribute table

```{r}
unresolved_edit <- read.table(unresolved_table, header = TRUE, sep = ",")
unresolved_edit.c1 <- as.data.frame(unresolved_edit$ID)
unresolved_edit.c2 <- as.data.frame(unresolved_edit$Reconcile.Action)
colnames(unresolved_edit.c1)[1] <- "ID"
colnames(unresolved_edit.c2)[1] <- "resolved"
unresolved_edit.join <- cbind(unresolved_edit.c1, unresolved_edit.c2)
```

### 3.b Load original attribute data and merge with unresolved cases

```{r}
attribute_ori <- read.csv(paste0(inputPU1_dir,"PUR_dbfinal.csv")) |> select(ID = NEW_ID, Rec_phase1b)
attribute.edit <- merge(attribute_ori, unresolved_edit.join, by = "ID", all = TRUE)
```

## 4. Resolve Any Unresolved Cases

```{r}
test <- as.data.frame(unique(unresolved_edit$Reconcile.Action))
test2 <- as.data.frame(unique(attribute$Rec_phase1b))
colnames(test)[1] <- "add"
colnames(test2)[1] <- "add"
test3 <- rbind(test, test2)
levels(attribute.edit$resolved) <- levels(test3$add)
colnames(attribute.edit)[1] <- "PU_name"

len <- nrow(attribute.edit)
for (s in 1:len) {
  if (is.na(attribute.edit$resolved[s])) {
    attribute.edit$resolved[s] <- attribute.edit$Rec_phase1b[s]
    attribute.edit$res_id[s] <- attribute.edit$PU_name[s]
  }
}
```

## 5. Create Unique Class IDs for Resolved Cases

```{r}
unique_class <- as.data.frame(unique(attribute.edit$resolved))
colnames(unique_class)[1] <- "resolved"
countrow <- nrow(unique_class)
unique_class$PU_ID <- seq(countrow)
attribute.edit <- merge(attribute.edit, unique_class, by = "resolved")
attribute.edit <- attribute.edit |> select(ID = PU_name, Rec_phase1b, resolved, res_id, PU_ID)
```

## 6. Save Final Reconcilitation Data

### 6.a Save Final Reconciliation Shapefile

```{r}
sa <- recon_file |> sf::st_as_sf()
sa <- merge(sa, attribute.edit, by = "ID", all = TRUE)
st_write(sa, paste0(output_dir, "/pur_recon_ciliation.shp"), driver = "ESRI Shapefile", append = FALSE)

plot(sa)
```

### 6.b Save Final Reconciliation Raster File

```{r}
pur_final_recon_rast <- terra::rasterize(vect(sa), rast(ref), field = "PU_ID", res = res(ref)[1], background = NA)
pur_final_recon_rast2 <- terra::rasterize(vect(sa), rast(ref), field = "resolved", res = res(ref)[1], background = NA)

plot(pur_final_recon_rast2)
```

### 6.c Create Summary of Final Reconciliation

```{r}
test4 <- raster(pur_final_recon_rast)
test4 <- ratify(test4, filename = paste0(output_dir, '/PUR.grd'), count = TRUE, overwrite = TRUE)
summary_PUR <- as.data.frame(levels(test4))
colnames(summary_PUR)[1] <- "PU_ID"
summary_PUR <- merge(summary_PUR, unique_class, by = "PU_ID")
```

### 6.d Reclassify and Save the Raster

```{r}
raster_temp <- reclassify(test4, cbind(NA, 255))
raster_temp_name <- paste0(output_dir, "/raster_temp.tif")
writeRaster(raster_temp, filename = raster_temp_name, format = "GTiff", overwrite = TRUE)
```

### 6.e Save Attribute Table

```{r}
pur_attribute_table <- summary_PUR
colnames(pur_attribute_table) <- c("ID", "COUNT", "Legend")
csv_file <- paste0(output_dir, "/csv_planning_unit.csv")
write.table(pur_attribute_table, file = csv_file, quote = FALSE, row.names = FALSE, sep = ",")
```

### 6.f Save RDS for Report

```{r}
dir.create(path = paste0(output_dir, "/report_files"))
saveRDS(pur_final_recon_rast, paste0(output_dir, "/pur_final_recon_rast.rds"))
saveRDS(summary_PUR, paste0(output_dir, "/summary_PUR.rds"))
```

### 6.g Save Summary as PUR Final Lookup Table

```{r}
summary_PUR$COUNT <- NULL
write.table(summary_PUR, "PUR_final_lookup_table.csv", quote = FALSE, row.names = FALSE, sep = ",")
```

## 7. Writing Final Status Message

```{r}
statuscode <- 1
statusmessage <- "PUR final reconciliation successfully completed!"
statusoutput <- data.frame(statuscode = statuscode, statusmessage = statusmessage)
```
