---
title: "SCIENDO Scenario Builder Report"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: united
    highlight: tango
    df_print: kable
params:
  start_time: NA
  end_time: NA
  inputs: NA
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load library and function, include=FALSE}
library(dplyr)
library(DT)
library(rmarkdown)
library(kableExtra)
library(htmltools)

format_session_info_table <- function() {
  si <- sessionInfo()
  
  # Extract R version info
  r_version <- si$R.version[c("major", "minor", "year", "month", "day", "nickname")]
  r_version <- paste0(
    "R ", r_version$major, ".", r_version$minor,
    " (", r_version$year, "-", r_version$month, "-", r_version$day, ")",
    " '", r_version$nickname, "'"
  )
  
  # Extract platform and OS info
  platform_os <- paste(si$platform, "|", si$running)
  
  # Extract locale info
  locale_info <- strsplit(si[[3]], ";")[[1]]
  locale_info <- paste(locale_info, collapse = "<br>")
  
  # Extract .libpaths, accomodate multiple library paths
  lib_paths <- .libPaths() |> paste( collapse = "<br>")
  
  # Combine all info into a single tibble
  session_summary <- tibble(
    Category = c("R Version", "Platform | OS", ".libPaths", "Locale"),
    Details = c(r_version, platform_os, lib_paths, locale_info)
  )
  return(session_summary)
}
```

```{r echo=FALSE}
scenario_modif_list <- params$inputs$scenario_modif_list
scen_list <- ""
for(i in 1:length(scenario_modif_list)) {
  scenario_modif <- scenario_modif_list[[i]]$abacus_scenario$scenario$tpm
  iter <- scenario_modif %>% distinct(iteration) %>% unlist() %>% as.vector()
  for(j in 1:length(iter)){
    # tm_desc <- paste0("Transition Matrix Scenario ", i, " Iteration-", iter[j])
    tm_path <- scenario_modif_list[[i]][[paste0('updated_tpm_', iter[j], '_path')]]
    scen_list <- paste0(scen_list, tm_path, "<br>")
  }
}
```

<details>

<summary>Click here for Analysis Log</summary>

```{r analysis-log, echo=FALSE}
analysis_log <- tribble(
  ~Category, ~Details,
  "Analysis Start",               params$start_time,
  "Analysis End",                 params$end_time,
  "Input Data and Parameters",    "",
  "QUES-C Database",              params$inputs$quescdb_path,
  "Output Workspace",             params$inputs$output_dir,
  "1. Transition Matrix Folder",  scen_list,
  "2. Baseline TPM",              paste0(params$inputs$output_dir, '/baseline_tpm_scenario_{nth}.csv'),
  "Session Summary", ""
) %>% rbind(format_session_info_table())

analysis_log %>% kbl(caption = "Analysis Log", escape = FALSE) %>%
  kable_paper("hover", full_width = F )
```

</details>

# Summary

This report presents the results of an analysis based on the QUES-C database generated by QUES-C module, which includes essential data such as land use/cover at T1 and T2, planning units, emission factor, and the corresponding year. 

# Module brief description

- SCIENDO-Scenario Builder works by comparing historical and projected land cover maps, identifying transitions between land use/cover classes and asessing the resulting impacts on emissions.

- The model generates results by integrating the land cover maps with defined planning units and linking the observed land use changes to emissions calculations. Scenario builder helps users compare alternative development strategies by simulating different scenarios.

# Input data 

## QUES-C Database

```{r load_quesdb, echo=FALSE, message=FALSE, warning=FALSE}
datatable(params$inputs$quescdb)
```

# Results 

## List of scenario {.tabset}

```{r echo=FALSE}
# $ label       
# $ desc
# $ abacus_scenario:List of 3
#  ..$ scenario  :List of 5
#  .. ..$ tpm
#  .. ..$ baseline_tpm
#  .. ..$ baseline_area
#  .. ..$ landcover
#  .. ..$ new_lc_id    : 
#  ..$ projection:List of 2
#  .. ..$ lc_area
#  .. ..$ lc_sum_area
#  ..$ emission  :List of 3
#  .. ..$ lc_emission 
#  .. ..$ zone_emission 
#  .. ..$ iteration_emission
# $ updated_tpm_1
# $ updated_tpm_1_path
```

```{r print tpm scenario, echo=FALSE, fig.keep='all', results='asis'}
for(i in 1:length(scenario_modif_list)) {
  label <- scenario_modif_list[[i]]$label
  scenario_modif <- scenario_modif_list[[i]]$abacus_scenario$scenario$tpm
  
  cat("### ", label, "\n\n")
  cat(
      knitr::knit_child(
        text = c(
          "```{r}",
          "#| echo: false",
          "scenario_modif %>% dplyr::select(period, zone, lc1, lc2, area) %>% datatable()",
          "```"
        ), quiet = TRUE
      ), sep = "\n"
    )
  cat('\n')
  
}
```


------------------------------------------------------------------------

<!-- Mandatory closing statement for all module -->

<font size="1"> LUMENS is free software and comes with ABSOLUTELY NO WARRANTY. Users are responsible for the results generated. Results depend on the quality of the input data ("garbage in, garbage out") and may vary or be sensitive to the parameters used. Please report any problems encountered while using LUMENS as [a GitHub issue](https://github.com/icraf-indonesia/lumens-shiny/issues). Feedback and questions are welcome [Contact Us URL]. </font size>