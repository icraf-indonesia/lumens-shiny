# This script validates QuES-C (Quantifying Ecosystem Services - Carbon) module outputs.
# It compares LUMENS-generated carbon emission data with ArcMap-processed data at both overall and planning unit (ID_PU) levels, and exports summary tables.

library(tidyverse)
library(readxl)
library(testthat)

# Load the carbon stock values.
cstock <- read_csv("data/table/carbon_bungo.csv") %>%
  dplyr::select(c(1, 3))

# Load the combined raster attribute table data processed from ArcMap.
quesc_combined_raster <- read_xlsx(
  "tests/testthat/data/quesc_verif_bungo_2000-2010_chng/bungo2000-2010_arcmap/lulcc_2000-2010_chng_bungo.xlsx"
) %>%
  rename(
    ID_PU = bungo_zone,
    ID_LC2 = bungo_lan2 ,
    ID_LC1 = bungo_lan1,
    Freq = Count) %>%
  left_join(cstock, by = join_by("ID_LC1" == "ID")) %>%
  rename(C_T1 =CARBON) %>%
  left_join(cstock, by = join_by("ID_LC2" == "ID")) %>%
  rename(C_T2 =CARBON) %>%
  select(-Value) %>%
  dplyr::relocate(ID_PU, ID_LC2, C_T2, ID_LC1, C_T1, ID_PU, Freq) %>%
  arrange(ID_PU, ID_LC2, ID_LC1) %>%
  mutate(em = (C_T1 - C_T2) * Freq)



# Load the combined raster attribute table data generated by LUMENS.
quesc_db <- read_csv(
  "tests/testthat/data/quesc_verif_bungo_2000-2010_chng/bungo2000-2010_lumens/quesc_database.csv") %>%
  select(ID_PU, ID_LC2, C_T2, ID_LC1, C_T1, ID_PU, Freq) %>%
  filter(Freq !=0)%>%
  mutate(em = (C_T1 - C_T2) * Freq)


# Calculate total emissions per ID_PU from the ArcMap processed data.
em_arcmap_per_pu <- quesc_combined_raster %>%
  group_by(ID_PU) %>%
  summarise(em_arcmap = sum(em, na.rm = TRUE))

# Calculate total emissions per ID_PU from the LUMENS generated data.
em_lumens_per_pu <- quesc_db %>%
  group_by(ID_PU) %>%
  summarise(em_lumens = sum(em, na.rm = TRUE))

# Combine the two datasets and calculate differences.
emission_summary_table <- full_join(em_arcmap_per_pu, em_lumens_per_pu, by = "ID_PU") %>%
  mutate(
    difference = em_lumens - em_arcmap,
    percentage_difference = (difference / em_arcmap) * 100
  ) %>%
  arrange(ID_PU)

# Print the summary table for verification.cat("Emission Difference Summary per Planning Unit (ID_PU):\n")
print(emission_summary_table)

# Calculate overall total emissions for overall percentage difference
# Create a table for overall total emissions and percentage difference.
overall_emission_summary <- tibble(
  Metric = c("Total Emissions (ArcMap)", "Total Emissions (LUMENS)", "Overall Percentage Difference (%)"),
  Value = c(total_em_arcmap, total_em_lumens, overall_percentage_difference)
)

# Print the overall summary table.
cat("\nOverall Emission Summary:\n")
print(overall_emission_summary)

# Export overall summary to CSV.
dir.create("tests/testthat/output", showWarnings = FALSE, recursive = TRUE)
write_csv(overall_emission_summary, "tests/testthat/output/overall_emission_summary.csv")

# Export emission_summary_table to CSV.
write_csv(emission_summary_table, "tests/testthat/output/emission_summary_per_pu.csv")


# Testthat assertions
test_that("Total emissions from LUMENS are close to ArcMap results (overall)", {
  expect_equal(total_em_lumens, total_em_arcmap, tolerance = 0.01) # Adjust tolerance as needed
})

test_that("Emissions per planning unit from LUMENS are close to ArcMap results", {
  # Ensure that the difference for each ID_PU is within an acceptable tolerance
  expect_true(all(abs(emission_summary_table$percentage_difference) < 1)) # Adjust tolerance as needed
}) 


