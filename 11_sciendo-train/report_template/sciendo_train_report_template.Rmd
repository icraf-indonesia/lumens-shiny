---
title: "SCIENDO-Train Report"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: united
    highlight: tango
    df_print: kable
params:
  start_time: NA
  end_time: NA
  inputs: NA
  rc_path: NA
  rc_egoml_path: NA
  woe_egoml_path: NA
  session_log: NA  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load function, include=FALSE, error=TRUE, warning=TRUE, message=TRUE}
source("../rscript/function_sciendo_train.R")
substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}
```

```{r load_library, include=FALSE}
library(raster)
library(dplyr)
library(DT)
library(rmarkdown)
library(kableExtra)
library(htmltools)
library(terra)
library(tidyterra)
library(LUMENSR)
```

<details><summary>Click here for Analysis Log</summary>

```{r analysis-log, echo=FALSE}
analysis_log <- tribble(
  ~Category,                      ~Details,
  "Analysis Start",               params$start_time,
  "Analysis End",                 params$end_time,
  "Input Data and Parameters",    "",
  "1. Landcover map at T1",       params$inputs$lc_t1_path,
  "2. Landcover map at T2",       params$inputs$lc_t2_path,
  "3. Planning unit",             params$inputs$zone_path,
  "4. Year of T1",                as.character(params$inputs$year1),
  "5. Year of T2",                as.character(params$inputs$year2),
  "6. Land cover lookup table",   params$inputs$lc_lookup_table_path,
  "Output Workspace",             params$inputs$output_dir,
  "1. Raster Cube",               params$rc_path,
  "2. EGOML Raster Cube",         params$rc_egoml_path,
  "3. EGOML Weight of Evidence",  params$woe_egoml_path,
  "Session Summary",              ""
) %>% rbind(params$session_log)

analysis_log %>% kbl(caption = "Analysis Log", escape = FALSE) %>%
  kable_paper("hover", full_width = F )
```

</details>

# Summary

```{r input-data, echo=FALSE, message=FALSE, warning=FALSE}
x <- params$inputs$zone_path
period <- as.numeric(params$inputs$year2) - as.numeric(params$inputs$year1)
if(substrRight(x, 3) == "tif"){
  df_pu <- read.csv(params$inputs$z_lookup_table_path) %>%
    dplyr::rename(ID_PU = 1, PU = 2)
  len <- nrow(df_pu)
  zone_rst <- x %>% raster()
  zone <- zone_rst %>% terra::rast() %>%
    add_legend_to_categorical_raster(., lookup_table = df_pu)
} else {
  zone_sf <- x %>% st_read(quiet = TRUE)
  zone <- zone_sf %>% rasterise_multipolygon(raster_res = c(100, 100), field = "IDS")
  df_pu <- data.frame(ID_PU = zone_sf[[1]], PU = zone_sf[[2]])
  len <- nrow(df_pu)
  zone_rst <- zone %>% raster()
  zone <- zone_rst %>% terra::rast() %>%
    add_legend_to_categorical_raster(., lookup_table = df_pu)
}

lc_t1 <- params$inputs$lc_t1_path %>% raster() %>% spatial_sync_raster(zone_rst)
lc_t2 <- params$inputs$lc_t2_path %>% raster() %>% spatial_sync_raster(zone_rst)

df_lc <- read.csv(params$input$lc_lookup_table_path)

#=Load landuse for two time periods
lc_t1 <- lc_t1 %>% terra::rast() %>%
  add_legend_to_categorical_raster(., lookup_table = df_lc, year = as.numeric(params$inputs$year1))
lc_t2 <- lc_t2 %>% terra::rast() %>%
  add_legend_to_categorical_raster(., lookup_table = df_lc, year = as.numeric(params$inputs$year2))
```

This report presents the results of an analysis based on the provided maps and lookup table.


# Module brief description

- SCIENDO-Train systematically collects crucial data that represents both the initial and final conditions of a given region. This includes various factor maps, which serve as explanatory variables, providing context and insights into the changes observed over time. By establishing these data points, SCIENDO-Train creates a comprehensive framework for understanding the dynamics of the region.

- The raster cube is an integrated collection of factor maps that captures significant geographic features of the area. This includes maps indicating distance to key landmarks, elevation levels that affect climate and ecosystem dynamics, and various environmental conditions, such as land use and vegetation cover. These factor maps are essential for analyzing spatial relationships and understanding how different elements interact within the region.

- To calculate the probability of the weight of evidence, a comparative analysis of all collected data values is performed. This involves assessing the relationships and variations among the factor maps and their influence on the observed conditions. 


# Input data {.tabset}

## Land-Use/Cover Map in `r params$inputs$year1`

```{r Land-Use/Cover Map T1, echo=FALSE, message=FALSE, warning=FALSE}
plot_categorical_raster(lc_t1)
```

## Land-Use/Cover Map in `r params$inputs$year2`

```{r Land-Use/Cover Map T2, echo=FALSE, message=FALSE, warning=FALSE}
plot_categorical_raster(lc_t2)
```

## Planning Unit

```{r Planning Unit, echo=FALSE, message=FALSE, warning=FALSE}
plot_categorical_raster(zone)
```

# Results

## Weight of Evidence Report  {.tabset}

```{r List of Csv of Woe, echo=FALSE}
listWoeReport <- params$inputs$output_dir %>% list.files(full.names=TRUE, pattern="weight_report*")
```

```{r print significant weight greater than 5, echo=FALSE, fig.keep='all', results='asis'}
out <- create_list_of_weight_report(listWoeReport, df_pu)
woe <- out$woe
df_zone <- out$df_zone
for(i in 1:out$n_zone){
  cat("### ", df_zone[i, 2], "\n\n")
  cat(paste("File location:", listWoeReport[i]))
  cat('\n\n')
  # cat(
  #   paste("Planning Unit:", df_zone[i, 2])
  # )
  # cat('\n')
  # cat('\n')
  for(j in woe[[paste0("pu", sprintf("%03d", i))]][['unique_transition']]) {
    report_per_transition <- woe[[paste0("pu", sprintf("%03d", i))]][['report']] %>% 
      filter(Transition == j) %>%
      filter(Significant == "yes") %>%
      filter(Weight_Coefficient > 5)
    unique_variable <- report_per_transition %>% 
      distinct(Variable.) %>% 
      unlist() %>% 
      as.vector()
    
    for(k in unique_variable) {
      report_per_transition_per_variable <- report_per_transition %>% filter(Variable. == k) %>% 
        select(
          Range, Possible_Transitions, Executed_Transitions, Weight_Coefficient, Contrast
        ) %>%
        mutate_if(is.double, as.character) %>%
        bind_rows(summarise(., across(where(is.integer), sum),
                            across(where(is.character), ~"") ))
      cat(
        paste(
          "Transition:", j, 
          "Variable:", k, 
          sep = " ")
      )
      
      cat('\n')
      cat('\n')
      cat(
        knitr::knit_child(
          text = c(
            "```{r}",
            "#| echo: false",
            "report_per_transition_per_variable %>% print.data.frame(row.names = F)",
            "```"
          ), quiet = TRUE
        ), sep = "\n"
      )
      
      cat('\n')
    }
  }
}
```

------------------------------------------------------------------------

<!-- Mandatory closing statement for all module -->

<font size="1"> LUMENS is free software and comes with ABSOLUTELY NO WARRANTY. Users are responsible for the results generated. Results depend on the quality of the input data ("garbage in, garbage out") and may vary or be sensitive to the parameters used. Please report any problems encountered while using LUMENS as [a GitHub issue](https://github.com/icraf-indonesia/lumens-shiny/issues). Feedback and questions are welcome [Contact Us URL]. </font size>