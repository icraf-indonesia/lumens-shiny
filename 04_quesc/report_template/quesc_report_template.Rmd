---
title: "QUES-C Report"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: united
    highlight: tango
    df_print: kable
params:
  start_time: NA
  end_time: NA
  map_c1: NA
  map_c2: NA
  map_em: NA
  map_sq: NA
  ques_db: NA
  p1: NA
  p2: NA
  inputs: NA
  session_log: NA  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath(rprojroot::find_rstudio_root_file()))
```

```{r load_lib_func, include=FALSE}
library(ggplot2)
library(raster)
library(dplyr)
library(kableExtra)
library(LUMENSR)
library(lattice)
library(rasterVis)

format_session_info_table <- function() {
  si <- sessionInfo()

  # Extract R version info
  r_version <- si$R.version[c("major", "minor", "year", "month", "day", "nickname")]
  r_version <- paste0(
    "R ", r_version$major, ".", r_version$minor,
    " (", r_version$year, "-", r_version$month, "-", r_version$day, ")",
    " '", r_version$nickname, "'"
  )

  # Extract platform and OS info
  platform_os <- paste(si$platform, "|", si[[6]])

  # Extract locale info
  locale_info <- strsplit(si[[3]], ";")[[1]]
  locale_info <- paste(locale_info, collapse = "<br>")

  # Extract .libpaths, accomodate multiple library paths
  lib_paths <- .libPaths() %>% paste( collapse = "<br>")

  # Combine all info into a single tibble
  session_summary <- tibble(
    Category = c("R Version", "Platform | OS", ".libPaths", "Locale"),
    Details = c(r_version, platform_os, lib_paths, locale_info)
  )
  
  return(session_summary)
}
```

<details><summary>Click here for Analysis Log</summary>

```{r analysis-log, echo=FALSE}

analysis_log <- tribble(
  ~Category,                      ~Details,
  "Analysis Start",               params$start_time,
  "Analysis End",                 params$end_time,
  "Input Data and Parameters",    "",
  "1. Landcover map at T1",       params$inputs$lc_t1_path,
  "2. Landcover map at T2",       params$inputs$lc_t2_path,
  "3. Planning unit",             params$inputs$admin_z_path,
  "4. Year of T1",                params$p1,
  "5. Year of T2",                params$p2,
  "6. Carbon stock lookup table", params$input$c_lookup_path,
  "Output Workspace",             params$input$output_dir,
  "1. Carbon Map at T1",          paste0(params$input$output_dir, "/carbon_map_t1.tif"),
  "2. Carbon Map at T2",          paste0(params$input$output_dir, "/carbon_map_t2.tif"),
  "3. Emission Map",              paste0(params$input$output_dir, "/emission_map.tif"),
  "4. Sequestration Map",         paste0(params$input$output_dir, "/sequestration_map.tif"),
  "5. QUES-C Database",           paste0(params$input$output_dir, "/quesc_database.csv"),
  "Session Summary",              "",
) %>% rbind(params$session_log)

analysis_log %>% kbl(caption = "Analysis Log", escape = FALSE) %>%
  kable_paper("hover", full_width = F )
```

</details>

# Summary

This report presents the results of an analysis based on the provided maps and lookup table.

## Summary of Emission Calculation



## Summary of Emission Calculation by Planning Unit



# Module brief description

- QUES-C describes the estimation of carbon stock for various land use types in a region using Stock Difference method, where the dynamics of carbon stock are based on the amount of carbon stock at two different points in time.

- Emission is obtained from the reduction in carbon stock in a land area due to land use changes from a land use type with high carbon stock to a land use type with low carbon stock.

- Sequestration is obtained from the increase in carbon stock in a land area due to land use changes from a land use type with low carbon stock to a land use type with high carbon stock.

# Input data {.tabset}

```{r input-data, echo=FALSE, message=FALSE, warning=FALSE}
zone_sf <- params$inputs$admin_z_path %>% st_read()
zone <- zone_sf %>% rasterise_multipolygon(raster_res = c(100, 100), field = "IDS")
df_pu <- data.frame(ID_PU = zone_sf[[1]], PU = zone_sf[[2]])

zone_rst <- zone %>% raster()
lc_t1 <- params$inputs$lc_t1_path %>% raster() %>% spatial_sync_raster(zone_rst)
lc_t2 <- params$inputs$lc_t2_path %>% raster() %>% spatial_sync_raster(zone_rst)

df_c <- read.csv(params$input$c_lookup_path)

#=Load landuse for two time periods
lc_t1 <- lc_t1 %>% rast() %>%
  add_legend_to_categorical_raster(., lookup_table = df_c, year = as.numeric(params$p1))
lc_t2 <- lc_t2 %>% rast() %>%
  add_legend_to_categorical_raster(., lookup_table = df_c, year = as.numeric(params$p2))
zone <- zone_rst %>% rast() %>%
  add_legend_to_categorical_raster(., lookup_table = df_pu)
```

## Land-Use/Cover Map in `r params$p1`

```{r Land-Use/Cover Map T1, echo=FALSE, message=FALSE, warning=FALSE}
plot_categorical_raster(lc_t1)
```

## Land-Use/Cover Map in `r params$p2`

```{r Land-Use/Cover Map T2, echo=FALSE, message=FALSE, warning=FALSE}
plot_categorical_raster(lc_t2)
```

## Planning Unit

```{r Planning Unit, echo=FALSE, message=FALSE, warning=FALSE}
plot_categorical_raster(zone)
```

## Carbon Stock Lookup Table

```{r Carbon Stock Lookup Table, echo=FALSE}
read.csv(params$inputs$c_lookup_path) %>% 
  kbl(caption = "Carbon Stock Lookup Table", escape = FALSE) %>%
  kable_paper("hover", full_width = F )
```

# Results

## QUES-C Database

QUES-C Database containing land cover transition between T1 and T2 in each planning unit with the value of carbon stock, emission, and sequestration.

Summary statistics of the table contains `r nrow(params$ques_db)` rows and `r names(params$ques_db)` columns.

```{r, echo=FALSE}
params$ques_db %>% head(n=10) %>%
  kbl(caption = "QUES-C Database", escape = FALSE) %>%
  kable_paper("hover", full_width = F )
```

## Carbon density map in `r nrow(params$p1)` (in tonne-C/ha)

Carbon map illustrating the distribution and amount of carbon stored in land use/cover data at T1.

```{r carbon_map_t1, echo=FALSE, message=FALSE, warning=FALSE}
y <- ceiling(minmax(params$map_c1)[2] / 100)
y <- y * 100
gplot(params$map_c1, maxpixels = 100000) + 
  geom_raster(aes(fill = value)) + 
  coord_equal() +
  scale_fill_gradient(name = "Carbon density" , low = "#FFCC66", high = "#003300", limits = c(0, y), breaks = c(0, 10, 20, 50, 100, 200, 300), guide = "colourbar") +
  theme(plot.title = element_text(lineheight = 5, face = "bold")) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 7),
        legend.key.height = unit(1.5, "cm"),
        legend.key.width = unit(0.375, "cm"))
```

## Carbon density map in `r nrow(params$p2)` (in tonne-C/ha)

Carbon map illustrating the distribution and amount of carbon stored in land use/cover data at T2.

```{r carbon_map_t2, echo=FALSE}
gplot(params$map_c2, maxpixels = 100000) + 
  geom_raster(aes(fill = value)) + 
  coord_equal() +
  scale_fill_gradient(name = "Carbon density" , low = "#FFCC66", high = "#003300", limits = c(0, y), breaks = c(0, 10, 20, 50, 100, 200, 300), guide = "colourbar") +
  theme(plot.title = element_text(lineheight = 5, face = "bold")) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 7),
        legend.key.height = unit(1.5, "cm"),
        legend.key.width = unit(0.375, "cm"))
```

## Emission map in `r params$p1`-`r params$p2`

Emission map illustrating a decrease in carbon stock amount from land use/cover T1 to land use/cover T2.

```{r emission_map, echo=FALSE}
gplot(params$map_em, maxpixels = 100000) + 
  geom_raster(aes(fill = value)) + 
  coord_equal() +
  scale_fill_gradient(name = "Emission (tonne CO2-eq)", low = "#FFCC66", high = "#FF0000", guide = "colourbar") +
  theme(plot.title = element_text(lineheight = 5, face = "bold")) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        legend.key.height = unit(0.375, "cm"),
        legend.key.width = unit(0.375, "cm"))
```

## Sequestration map in `r params$p1`-`r params$p2`

Sequestration map illustrating an increase in carbon stock amount from land use/cover T1 to land use/cover T2.

```{r sequestration_map, echo=FALSE}
gplot(params$map_sq, maxpixels = 100000) + 
  geom_raster(aes(fill=value)) + 
  coord_equal() +
  scale_fill_gradient(name = "Sequestration (tonne CO2-eq)",low = "#FFCC66", high = "#000033", guide = "colourbar") +
  theme(plot.title = element_text(lineheight = 5, face = "bold")) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        legend.key.height = unit(0.375, "cm"),
        legend.key.width = unit(0.375, "cm"))
```

