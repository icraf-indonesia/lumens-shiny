---
title: "QUES-C Report"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: united
    highlight: tango
    df_print: kable
params:
  start_time: NA
  end_time: NA
  map_c1: NA
  map_c2: NA
  map_em: NA
  map_sq: NA
  ques_db: NA
  p1: NA
  p2: NA
  inputs: NA
  session_log: NA  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load function, include=FALSE, error=TRUE, warning=TRUE, message=TRUE}
fun_path <- here::here("04_quesc", "rscript", "function_ques_c.R")

if (!file.exists(fun_path)) {
  stop(paste("Template file not found at:", fun_path))
}
source(fun_path)
```

```{r load_library, include=FALSE}
install_load(
  "raster",
  "ggplot2",
  "dplyr",
  "reshape",
  "lattice",
  "rasterVis",
  "DT",
  "kableExtra",
  "tidyterra",
  "htmltools"
)
if (!("LUMENSR" %in% rownames(installed.packages()))) {
  install_github("icraf-indonesia/LUMENSR", force = T)
  do.call("library", list("LUMENSR"))
}
library(LUMENSR)
```

<details>

<summary>Click here for Analysis Log</summary>

```{r analysis-log, echo=FALSE}
analysis_log <- tribble(
  ~Category,                      ~Details,
  "Analysis Start",               params$start_time,
  "Analysis End",                 params$end_time,
  "Input Data and Parameters",    "",
  "1. Landcover map at T1",       params$inputs$lc_t1_path,
  "2. Landcover map at T2",       params$inputs$lc_t2_path,
  "3. Planning unit",             params$inputs$admin_z_path,
  "4. Year of T1",                as.character(params$p1),
  "5. Year of T2",                as.character(params$p2),
  "6. Carbon stock lookup table", params$inputs$c_lookup_path,
  "Output Workspace",             params$inputs$output_dir,
  "1. Carbon Map at T1",          paste0(params$inputs$output_dir, "/carbon_map_t1.tif"),
  "2. Carbon Map at T2",          paste0(params$inputs$output_dir, "/carbon_map_t2.tif"),
  "3. Emission Map",              paste0(params$inputs$output_dir, "/emission_map.tif"),
  "4. Sequestration Map",         paste0(params$inputs$output_dir, "/sequestration_map.tif"),
  "5. QUES-C Database",           paste0(params$inputs$output_dir, "/quesc_database.csv"),
  "Session Summary",              ""
) %>% rbind(params$session_log)

analysis_log %>%
  kbl(caption = "Analysis Log", escape = FALSE) %>%
  kable_paper("hover", full_width = F)
```

</details>

# Summary

```{r input-data, echo=FALSE, message=FALSE, warning=FALSE}
period <- as.numeric(params$p2) - as.numeric(params$p1)
df_c <- read.csv(params$input$c_lookup_path)

# =Load landuse for two time periods
lc_t1 <- params$inputs$lc_t1_path %>%
  rast() %>%
  add_legend_to_categorical_raster(., lookup_table = df_c, year = as.numeric(params$p1))
lc_t2 <- params$inputs$lc_t2_path %>%
  rast() %>%
  add_legend_to_categorical_raster(., lookup_table = df_c, year = as.numeric(params$p2))

# Determine if the planning unit input is a shapefile or raster
admin_z_path <- params$inputs$admin_z_path

if (grepl("\\.shp$", admin_z_path, ignore.case = TRUE)) {
  # If input is a shapefile
  zone_sf <- sf::st_read(admin_z_path, quiet = TRUE)
  zone_sf <- sf::st_cast(zone_sf, "MULTIPOLYGON")
  map_res <- res(lc_t1)
  # Use the first column as ID, second as name (adjust if needed)
  zone_rst <- rasterise_multipolygon_quesc(
    zone_sf,
    raster_res = map_res,
    field = colnames(sf::st_drop_geometry(zone_sf))[1]
  ) %>% check_and_harmonise_geometry(reference_map = lc_t1)

  df_pu <- data.frame(
    ID_PU = zone_sf[[1]],
    PU = if (ncol(zone_sf) > 1) zone_sf[[2]] else zone_sf[[1]]
  )
  zone_rst <- zone_rst %>%
    add_legend_to_categorical_raster(., lookup_table = df_pu)
} else if (grepl("\\.tif$", admin_z_path, ignore.case = TRUE)) {
  # If input is a raster
  zone_rst <- terra::rast(admin_z_path) %>%
    check_and_harmonise_geometry(reference_map = lc_t1)
} else {
  stop("Unsupported planning unit file format: must be .shp or .tif")
}
```
This report presents the results of an analysis based on the provided maps and lookup table.

## Summary of Emission Calculation

```{r summary_emission, echo=FALSE, message=FALSE, warning=FALSE}
s <- summary_of_emission_calculation(
  quescdb = params$ques_db,
  zone = zone_rst,
  map_em = paste0(params$inputs$output_dir, "/emission_map.tif"),
  map_sq = paste0(params$inputs$output_dir, "/sequestration_map.tif"),
  period = list(p1 = params$p1, p2 = params$p2)
)

datatable(s$summary_df)
```

## Summary of Emission Calculation by Planning Unit


### Summary of Emissions and Sequestration by Planning Unit

```{r summary_emission_by_pu_e, echo=FALSE, message=FALSE, warning=FALSE}
datatable(s$zone_carbon)
# s$zone_carbon %>% kbl(caption = "Summary of Emissions and Sequestration by Planning Unit", escape = F) %>%
#   kable_paper("hover", full_width = F)
```

### Carbon Stock and Net Emission Summary Across Time Periods by Planning Unit

```{r summary_emission_by_pu_c, echo=FALSE, message=FALSE, warning=FALSE}
z <- zonal_statistic_database(
  quescdb = params$ques_db,
  period = period
)

colnames(z$data_zone_df)[colnames(z$data_zone_df) == "Carbon Avg. (Periode 1)"] <- paste("Carbon Average", params$p1)
colnames(z$data_zone_df)[colnames(z$data_zone_df) == "Carbon Avg. (Periode 2)"] <- paste("Carbon Average", params$p2)

datatable(z$data_zone_df)
```

# Module brief description

-   QUES-C describes the estimation of carbon stock for various land use types in a region using Stock Difference method, where the dynamics of carbon stock are based on the amount of carbon stock at two different points in time.

-   Emission is obtained from the reduction in carbon stock in a land area due to land use changes from a land use type with high carbon stock to a land use type with low carbon stock.

-   Sequestration is obtained from the increase in carbon stock in a land area due to land use changes from a land use type with low carbon stock to a land use type with high carbon stock.

# Input data {.tabset}

## Land-Use/Cover Map in `r params$p1`

```{r Land-Use/Cover Map T1, echo=FALSE, message=FALSE, warning=FALSE}
plot_categorical_raster(lc_t1)
```

## Land-Use/Cover Map in `r params$p2`

```{r Land-Use/Cover Map T2, echo=FALSE, message=FALSE, warning=FALSE}
plot_categorical_raster(lc_t2)
```

## Planning Unit

```{r Planning Unit, echo=FALSE, message=FALSE, warning=FALSE}
plot_categorical_raster(zone)
```

## Carbon Stock Lookup Table

The carbon stock being considered is time-averaged above ground carbon stock.


```{r Carbon Stock Lookup Table, echo=FALSE, message=FALSE, warning=FALSE}
datatable(
  read.csv(params$inputs$c_lookup_path)
)
```

# Results

## QUES-C Database

QUES-C Database containing land cover transition between `r params$p1` and `r params$p2` in each planning unit with the value of carbon stock, emission, and sequestration.

Summary statistics of the table contains `r nrow(params$ques_db)` rows and `r names(params$ques_db)` columns.

```{r load_quesdb, echo=FALSE, message=FALSE, warning=FALSE}
datatable(params$ques_db)
```

## Carbon density map in `r params$p1`

Carbon map illustrating the distribution and amount of carbon stored in land use/cover data at `r params$p1` (in tonne-C/ha).

```{r carbon_map_t1, echo=FALSE, message=FALSE, warning=FALSE}
y <- ceiling(minmax(params$map_c1)[2] / 100)
y <- y * 100
plot_quesc_results(
  map = params$map_c1,
  legend = "Carbon density (tonne-C/ha)",
  low = "#FFCC66",
  high = "#003300",
  # limits = c(0,y),
  # breaks = c(0,10,20,50,100,200,300),
  # title_size = 8,
  # text_size = 7,
  # height = 1.5,
  # width = 0.375
)
```

## Carbon density map in `r params$p2`

Carbon map illustrating the distribution and amount of carbon stored in land use/cover data at `r params$p2` (in tonne-C/ha).

```{r carbon_map_t2, echo=FALSE, message=FALSE, warning=FALSE}
plot_quesc_results(
  map = params$map_c2,
  legend = "Carbon density (tonne-C/ha)",
  low = "#FFCC66",
  high = "#003300",
  # limits = c(0,y),
  # breaks = c(0,10,20,50,100,200,300),
  # title_size = 8,
  # text_size = 7,
  # height = 1.5,
  # width = 0.375
)
```

## Emission map in `r params$p1`-`r params$p2`

Emission map illustrating a decrease in carbon stock amount (in tonne CO2-eq/ha).

```{r emission_map, echo=FALSE, message=FALSE, warning=FALSE}
plot_quesc_results(
  map = params$map_em,
  legend = "Emission (tonne CO2-eq/ha)",
  low = "#FFCC66",
  high = "#FF0000"
)
```

## Sequestration map in `r params$p1`-`r params$p2`

Sequestration map illustrating an increase in carbon stock amount (in tonne CO2-eq/ha).

```{r sequestration_map, echo=FALSE, message=FALSE, warning=FALSE}
plot_quesc_results(
  map = params$map_sq,
  legend = "Sequestration (tonne CO2-eq/ha)",
  low = "#FFCC66",
  high = "#000033"
)
```

## Average of Net Emission Rate

```{r avg_net_em_rate, echo=FALSE, message=FALSE, warning=FALSE}
s$plot_zone_carbon
```

## Average Carbon Density in `r params$p1`

```{r avg carbon density 1, echo=FALSE, message=FALSE, warning=FALSE}
reclassify_matrix <- as.matrix(z$data_zone[, 1]) %>%
  cbind(., as.matrix(z$data_zone[, 4])) %>%
  rbind(., c(0, NA))
z_avg_c1 <- zone %>% classify(reclassify_matrix)
plot_quesc_results(
  map = z_avg_c1,
  legend = "Carbon Density Level (tonne-C/ha)",
  low = "#FFCC66",
  high = "#003300"
)
```

## Average Carbon Density in `r params$p2`

```{r avg carbon density 2, echo=FALSE, message=FALSE, warning=FALSE}
reclassify_matrix <- as.matrix(z$data_zone[, 1]) %>%
  cbind(., as.matrix(z$data_zone[, 5])) %>%
  rbind(., c(0, NA))
z_avg_c2 <- zone %>% classify(reclassify_matrix)
plot_quesc_results(
  map = z_avg_c2,
  legend = "Carbon Density Level (tonne-C/ha)",
  low = "#FFCC66",
  high = "#003300"
)
```

## Average Carbon Emission Rates by Planning Unit

The map below shows the average carbon emission rates (tonne CO2-eq/ha.yr) across planning units, representing the release of carbon from land cover changes. Darker areas indicate higher emission levels.

```{r avg emission rate, echo=FALSE, message=FALSE, warning=FALSE}
reclassify_matrix <- as.matrix(z$data_zone[, 1]) %>%
  cbind(., as.matrix(z$data_zone[, 6])) %>%
  rbind(., c(0, NA))

z_em_rate <- zone %>% classify(reclassify_matrix)
plot_quesc_results(
  map = z_em_rate,
  legend = "Emission Level (Tonne CO2-eq/ha.yr)",
  low = "#FFCC66",
  high = "#003300"
)
```

## Average Carbon Sequestration Rates by Planning Unit

The map below shows the average carbon sequestration rates (tonne CO2-eq/ha.yr) across planning units, indicating increases in above-ground carbon stocks due to land cover changes. Darker greens represent higher sequestration levels.

```{r avg sequestration rate, echo=FALSE, message=FALSE, warning=FALSE}
reclassify_matrix <- as.matrix(z$data_zone[, 1]) %>%
  cbind(., as.matrix(z$data_zone[, 7])) %>%
  rbind(., c(0, NA))
z_sq_rate <- zone %>% classify(reclassify_matrix)
plot_quesc_results(
  map = z_sq_rate,
  legend = "Sequestration Level (Tonne CO2-eq/ha.yr)",
  low = "#FFCC66",
  high = "#003300"
)
```

## The Largest Source of Emission {.tabset}

### Plot

```{r plot_largest_em, echo=FALSE, message=FALSE, warning=FALSE}
z$largest_emission
```

### Table


```{r tbl_largest_em, echo=FALSE, message=FALSE, warning=FALSE}
tbl_largest_em <- z$tb_em_total_10_summary
tbl_largest_em <- tbl_largest_em[-1]

datatable(tbl_largest_em)
# z$tb_em_total_10_summary %>% kbl(caption = "The Largest Source of Emission", escape = F) %>%
#   kable_paper("hover", full_width = F)
```

## The Largest Source of Sequestration {.tabset}

### Plot

```{r plot_largest_sq, echo=FALSE, message=FALSE, warning=FALSE}
z$largest_sequestration
```

### Table

```{r tbl_largest_sq, echo=FALSE, message=FALSE, warning=FALSE}
tbl_largest_sq <- z$tb_sq_total_10_summary
tbl_largest_sq <- tbl_largest_sq[-1]

datatable(tbl_largest_sq)
# z$tb_sq_total_10_summary %>% kbl(caption = "The Largest Source of Sequestration", escape = F) %>%
#   kable_paper("hover", full_width = F)
```

------------------------------------------------------------------------

<!-- Mandatory closing statement for all module -->

<font size="1"> LUMENS is free software and comes with ABSOLUTELY NO WARRANTY. Users are responsible for the results generated. Results depend on the quality of the input data ("garbage in, garbage out") and may vary or be sensitive to the parameters used. Please report any problems encountered while using LUMENS as [a GitHub issue](https://github.com/icraf-indonesia/lumens-shiny/issues). Feedback and questions are welcome [Contact Us URL]. </font size>