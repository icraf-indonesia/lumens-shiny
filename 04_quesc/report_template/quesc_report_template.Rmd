---
title: "QuES-C Report"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: united
    highlight: tango
    df_print: kable
params:
  start_time: NA
  end_time: NA
  map_c1: NA
  map_c2: NA
  map_em: NA
  map_sq: NA
  ques_db: NA
  p1: NA
  p2: NA
  lc_t1: NA
  lc_t2: NA
  zone: NA
  df_pu: NA
  df_c: NA
  peatmap: NA
  lookup_c.pt: NA
  inputs: NA
  tbl_quesc_peat: NA
  tbl_quesc_peat_sum: NA
  map_e_peat: NA
  map_e_mineral_peat: NA
  quesc_database_mineral_peat: NA
  peat_decomposition: NA
  session_log: NA  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load function, include=FALSE, error=TRUE, warning=TRUE, message=TRUE}
source("../rscript/function_ques_c.R")
```

```{r load_library, include=FALSE}
install_load(
  "raster",
  "terra",
  "ggplot2",
  "dplyr",
  "reshape",
  "lattice",
  "rasterVis",
  "DT",
  "kableExtra",
  "tidyterra",
  "htmltools",
  "DT"
)
if (!("LUMENSR" %in% rownames(installed.packages()))) {
  install_github("icraf-indonesia/LUMENSR", force = T)
  do.call("library", list("LUMENSR"))
}
library(LUMENSR)
```

<details>

<summary>Click here for Analysis Log</summary>

```{r analysis-log, echo=FALSE}
analysis_log <- tribble(
  ~Category,                      ~Details,
  "Analysis Start",               params$start_time,
  "Analysis End",                 params$end_time,
  "Input Data and Parameters",    "",
  "1. Landcover map at T1",       params$inputs$lc_t1_path,
  "2. Landcover map at T2",       params$inputs$lc_t2_path,
  "3. Planning unit",             params$inputs$admin_z_path,
  "4. Year of T1",                as.character(params$p1),
  "5. Year of T2",                as.character(params$p2),
  "6. Carbon stock lookup table", params$inputs$c_lookup_path,
  "Output Workspace",             params$inputs$output_dir,
  "1. Carbon Map at T1",          paste0(params$inputs$output_dir, "/carbon_map_t1.tif"),
  "2. Carbon Map at T2",          paste0(params$inputs$output_dir, "/carbon_map_t2.tif"),
  "3. Emission Map",              paste0(params$inputs$output_dir, "/emission_map.tif"),
  "4. Sequestration Map",         paste0(params$inputs$output_dir, "/sequestration_map.tif"),
  "5. QUES-C Database",           paste0(params$inputs$output_dir, "/quesc_database.csv"),
  "Session Summary",              ""
) %>% rbind(params$session_log)

analysis_log %>% kbl(caption = "Analysis Log", escape = FALSE) %>%
  kable_paper("hover", full_width = F )
```

</details>

# Summary

```{r input-data, echo=FALSE, message=FALSE, warning=FALSE}
period <- as.numeric(params$p2) - as.numeric(params$p1)
df_pu <- params$df_pu
zone_rst <- params$zone %>% raster()
df_c <- params$df_c
```

This report presents the results of an analysis based on the provided maps and lookup table.

## Summary of Emission Calculation

```{r summary_emission, echo=FALSE, fig.align='left', fig.keep='all', results='asis', message=FALSE, warning=FALSE}
if (params$peat_decomposition == "Yes") {
  s <- summary_of_emission_calculation(
  quescdb = params$quesc_database_mineral_peat,
  zone = zone_rst, 
  map_em = params$map_e_mineral_peat, 
  map_sq = params$map_sq, 
  period = list(p1 = params$p1, p2 = params$p2)
  )
} else {
  s <- summary_of_emission_calculation(
  quescdb = params$ques_db,
  zone = zone_rst, 
  map_em = params$map_em, 
  map_sq = params$map_sq, 
  period = list(p1 = params$p1, p2 = params$p2)
  )
}

s$summary_df %>% datatable()
  # kbl(caption = "Summary of Emission Calculation", escape = F) %>%
  # kable_paper("hover", full_width = F)
```

## Summary of Emission Calculation by Planning Unit {.tabset}

### Summary of Emissions and Sequestration by Planning Unit

```{r summary_emission_by_pu_e, echo=FALSE, fig.align='left', fig.keep='all', results='asis', message=FALSE, warning=FALSE}
s$zone_carbon %>% datatable()
  # kbl(caption = "Summary of Emissions and Sequestration by Planning Unit", escape = F) %>%
  # kable_paper("hover", full_width = F)
```

### Carbon Stock and Net Emission Summary Across Time Periods by Planning Unit

```{r summary_emission_by_pu_c, echo=FALSE, fig.align='left', fig.keep='all', results='asis', message=FALSE, warning=FALSE}
if (params$peat_decomposition == "Yes") {
  z <- zonal_statistic_database(
  quescdb = params$quesc_database_mineral_peat,
  period = period
  )
} else {
  z <- zonal_statistic_database(
  quescdb = params$ques_db,
  period = period
  )
}

colnames(z$data_zone_df)[colnames(z$data_zone_df) == "Carbon Avg. (Periode 1)"] <- paste("Carbon Average", params$p1)
colnames(z$data_zone_df)[colnames(z$data_zone_df) == "Carbon Avg. (Periode 2)"] <- paste("Carbon Average", params$p2)

z$data_zone_df %>% datatable()
  # kbl(caption = "Carbon Stock and Net Emission Summary Across Time Periods by Planning Unit", escape = F) %>%
  # kable_paper("hover", full_width = F)
```

# Module brief description

-   QUES-C describes the estimation of carbon stock for various land use types in a region using Stock Difference method, where the dynamics of carbon stock are based on the amount of carbon stock at two different points in time.

-   Emission is obtained from the reduction in carbon stock in a land area due to land use changes from a land use type with high carbon stock to a land use type with low carbon stock.

-   Sequestration is obtained from the increase in carbon stock in a land area due to land use changes from a land use type with low carbon stock to a land use type with high carbon stock.

# Input data {.tabset}

## Land-Use/Cover Map in `r params$p1`

```{r Land-Use/Cover Map T1, echo=FALSE, message=FALSE, warning=FALSE}
plot_categorical_raster(lc_t1)
```

## Land-Use/Cover Map in `r params$p2`

```{r Land-Use/Cover Map T2, echo=FALSE, message=FALSE, warning=FALSE}
plot_categorical_raster(lc_t2)
```

## Planning Unit

```{r Planning Unit, echo=FALSE, message=FALSE, warning=FALSE}
plot_categorical_raster(zone)
```

```{r Peat Land Map, echo=FALSE, fig.align='left', fig.keep='all', results='asis', message=FALSE, warning=FALSE}
if (params$peat_decomposition == "Yes") {
  cat("## Peatland Map\n\n")
  zone <- classify(params$zone, cbind(1:length(unique(values(params$zone))), 1))
  zone_poly <- as.polygons(zone)
}

if (params$peat_decomposition == "Yes") {
  if (!is.factor(values(params$peatmap))) {
    peatmap <- as.factor(params$peatmap)
  }
  plot(peatmap, colNA = NULL, main = "Peatland", plg=list(x='topright'))
  plot(zone_poly, add = TRUE, border = 'black', lwd = 1)
}
```

## Carbon Stock Table

The carbon stock being considered is time-averaged above ground carbon stock.

```{r Carbon Stock Lookup Table, echo=FALSE}
read.csv(params$inputs$c_lookup_path) %>% 
  datatable()
  # kbl(caption = "Carbon Stock Lookup Table", escape = FALSE) %>%
  # kable_paper("hover", full_width = F )
```

```{r Peat Emission Factor Table, echo=FALSE, fig.align='left', fig.keep='all', results='asis', message=FALSE, warning=FALSE}
if (params$peat_decomposition == "Yes") {
  cat("## Peat Emission Factor Table\n\n")
}

if (params$peat_decomposition == "Yes") {
  datatable(params$lookup_c.pt)
}
```

# Results

## QUES-C Database

QUES-C Database containing land cover transition between `r params$p1` and `r params$p2` in each planning unit with the value of carbon stock, emission, and sequestration.

Summary statistics of the table contains `r nrow(params$ques_db)` rows and `r names(params$ques_db)` columns.

```{r load_quesdb, echo=FALSE, message=FALSE, warning=FALSE}
if (params$peat_decomposition == "Yes") {
  datatable(quesc_database_mineral_peat)
} else {
  tbl_quesc_filtered <- params$ques_db %>% filter(!(Freq == 0 & Ha == 0))
  datatable(tbl_quesc_filtered) 
}
```

## Carbon Density Map {.tabset}

### Carbon density map in `r params$p1`

Carbon map illustrating the distribution and amount of carbon stored in land use/cover data at `r params$p1` (in tonne-C/ha).

```{r carbon_map_t1, echo=FALSE, message=FALSE, warning=FALSE}
y <- ceiling(minmax(params$map_c1)[2] / 100)
y <- y * 100
plot_quesc_results(
  map = params$map_c1, 
  legend = "Carbon density (tonne-C/ha)", 
  low = "#FFCC66", 
  high = "#003300", 
  limits = c(0,y), 
  breaks = c(0,10,20,50,100,200,300), 
  title_size = 8, 
  text_size = 7, 
  height = 1.5, 
  width = 0.375
)
```

### Carbon density map in `r params$p2`

Carbon map illustrating the distribution and amount of carbon stored in land use/cover data at `r params$p2` (in tonne-C/ha).

```{r carbon_map_t2, echo=FALSE}
plot_quesc_results(
  map = params$map_c2, 
  legend = "Carbon density (tonne-C/ha)", 
  low = "#FFCC66", 
  high = "#003300", 
  limits = c(0,y), 
  breaks = c(0,10,20,50,100,200,300), 
  title_size = 8, 
  text_size = 7, 
  height = 1.5, 
  width = 0.375
)
```

## Emission map in `r params$p1`-`r params$p2` {.tabset}

Emission map illustrating a decrease in carbon stock amount (in tonne CO2-eq/ha).

```{r emission_map_head, echo=FALSE, fig.align='left', fig.keep='all', results='asis', message=FALSE, warning=FALSE}
if (params$peat_decomposition == "Yes") {
  cat("### Mineral-land Emission Map Table\n\n")
}
```

```{r emission_map, echo=FALSE, fig.align='left', fig.keep='all', results='asis', message=FALSE, warning=FALSE}
plot_quesc_results(
    map = params$map_em, 
    legend = "Emission (tonne CO2-eq/ha)", 
    low = "#FFCC66", 
    high = "#FF0000"
  )
```

```{r Peat Emission Map head, echo=FALSE, fig.align='left', fig.keep='all', results='asis', message=FALSE, warning=FALSE}
if (params$peat_decomposition == "Yes") {
  cat("### Peat-land Emission Map\n\n")
}
```

```{r Peat Emission Map, echo=FALSE, fig.align='left', fig.keep='all', results='asis', message=FALSE, warning=FALSE}
if (params$peat_decomposition == "Yes") {
  plot_quesc_results(
    map = params$map_e_peat,
    legend = "Emission (tonne CO2-eq/ha)",
    low = "#FFCC66", 
    high = "#FF0000"
  )
}
```

```{r Total Emission Map head, echo=FALSE, fig.align='left', fig.keep='all', results='asis', message=FALSE, warning=FALSE}
if (params$peat_decomposition == "Yes") {
  cat("### Total Emission Map\n\n")
}
```

```{r Total Emission Map, echo=FALSE, fig.align='left', fig.keep='all', results='asis', message=FALSE, warning=FALSE}
if (params$peat_decomposition == "Yes") {
  plot_quesc_results(
    map = params$map_e_mineral_peat,
    legend = "Emission (tonne CO2-eq/ha)",
    low = "#FFCC66", 
    high = "#FF0000"
  )
}
```

## Sequestration map in `r params$p1`-`r params$p2`

Sequestration map illustrating an increase in carbon stock amount (in tonne CO2-eq/ha).

```{r sequestration_map, echo=FALSE}
plot_quesc_results(
  map = params$map_sq, 
  legend = "Sequestration (tonne CO2-eq/ha)", 
  low = "#FFCC66", 
  high = "#000033"
)
```

## Average of Net Emission Rate

```{r avg_net_em_rate, echo=FALSE}
s$plot_zone_carbon
```

## Average Carbon Density {.tabset}

### Average Carbon Density in `r params$p1`

```{r avg carbon density 1, echo=FALSE}
reclassify_matrix <- as.matrix(z$data_zone[, 1]) %>% 
    cbind(., as.matrix(z$data_zone[, 4])) %>%
    rbind(., c(0, NA))
z_avg_c1 <- zone %>% classify(reclassify_matrix)
plot_quesc_results(
  map = z_avg_c1, 
  legend = "Carbon Density Level (tonne-C/ha)", 
  low = "#FFCC66", 
  high = "#003300"
)
```

### Average Carbon Density in `r params$p2`

```{r avg carbon density 2, echo=FALSE}
reclassify_matrix <- as.matrix(z$data_zone[, 1]) %>% 
    cbind(., as.matrix(z$data_zone[, 5])) %>%
    rbind(., c(0, NA))
z_avg_c2 <- zone %>% classify(reclassify_matrix)
plot_quesc_results(
  map = z_avg_c2, 
  legend = "Carbon Density Level (tonne-C/ha)", 
  low = "#FFCC66", 
  high = "#003300"
)
```

## Average Carbon Emission Rates by Planning Unit

The map below shows the average carbon emission rates (tonne CO2-eq/ha.yr) across planning units, representing the release of carbon from land cover changes. Darker areas indicate higher emission levels.

```{r avg emission rate, echo=FALSE}
reclassify_matrix <- as.matrix(z$data_zone[, 1]) %>% 
    cbind(., as.matrix(z$data_zone[, 6])) %>%
    rbind(., c(0, NA))
z_em_rate <- zone %>% classify(reclassify_matrix)
plot_quesc_results(
  map = z_em_rate, 
  legend = "Emission Level (Tonne CO2-eq/ha.yr)", 
  low = "#FFCC66", 
  high = "#003300"
)
```

## Average Carbon Sequestration Rates by Planning Unit

The map below shows the average carbon sequestration rates (tonne CO2-eq/ha.yr) across planning units, indicating increases in above-ground carbon stocks due to land cover changes. Darker greens represent higher sequestration levels.

```{r avg sequestration rate, echo=FALSE}
reclassify_matrix <- as.matrix(z$data_zone[, 1]) %>% 
    cbind(., as.matrix(z$data_zone[, 7])) %>%
    rbind(., c(0, NA))
z_sq_rate <- zone %>% classify(reclassify_matrix)
plot_quesc_results(
  map = z_sq_rate, 
  legend = "Sequestration Level (Tonne CO2-eq/ha.yr)", 
  low = "#FFCC66", 
  high = "#003300"
)
```

## The Largest Source of Emission {.tabset}

### Plot

```{r plot_largest_em, echo=FALSE}
z$largest_emission
```

### Table

```{r tbl_largest_em, echo=FALSE}
z$tb_em_total_10_summary %>% kbl(caption = "The Largest Source of Emission", escape = F) %>%
  kable_paper("hover", full_width = F)
```

## The Largest Source of Sequestration {.tabset}

### Plot

```{r plot_largest_sq, echo=FALSE}
z$largest_sequestration
```

### Table

```{r tbl_largest_sq, echo=FALSE}
z$tb_sq_total_10_summary %>% kbl(caption = "The Largest Source of Sequestration", escape = F) %>%
  kable_paper("hover", full_width = F)
```

------------------------------------------------------------------------

<!-- Mandatory closing statement for all module -->

<font size="1"> LUMENS is free software and comes with ABSOLUTELY NO WARRANTY. Users are responsible for the results generated. Results depend on the quality of the input data ("garbage in, garbage out") and may vary or be sensitive to the parameters used. Please report any problems encountered while using LUMENS as [a GitHub issue](https://github.com/icraf-indonesia/lumens-shiny/issues). Feedback and questions are welcome [Contact Us URL]. </font size>
