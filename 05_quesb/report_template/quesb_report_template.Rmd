---
title: "QuES-B Report"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    df_print: kable
params:
  start_time: NA
  end_time: NA
  output_dir: NA
  total_area: NA
  dir_teci_map: NA
  dir_focal_area_: NA
  dir_sampling_grid: NA
  dir_difa_table: NA
  difa_table: NA
  difa_score: NA
  inputs: NA
  session_log: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(tibble)
library(stringr)
library(kableExtra)
library(tidyterra)
knitr::opts_knit$set(root.dir = normalizePath(rprojroot::find_rstudio_root_file()))

```



# Analysis Log

```{r analysis-log, echo=FALSE}
source("05_quesb/rscript/ques_biodiv_functions.r")


analysis_log <- tribble(
  ~Category,                   ~Details,
  "Analysis Start",        params$start_time,
  "Analysis End",          params$end_time,
  "Input Data and Parameters", "",
  "1. Landcover map",      params$inputs$lc_t1_path,
  "2. Year", as.character(params$inputs$t1),
  "3. Landcover lookup",   params$inputs$lulc_lut_path,
  "4. Contrast table",     params$inputs$contab_path,
  "5. NoData land-cover class", as.character(params$inputs$raster.nodata),
  "6. Number of sampling points (n)", as.character(params$inputs$sampling_points),
  "7. Mowing window radius (metres)", as.character(params$inputs$window_size),
  "8. Mowing window shape", as.character(params$inputs$window.shap),
  "9. Fragstats config file", params$inputs$fca_path,
  "10. Fragstats directory", params$inputs$fragstats_path,
  "Output Files", "",
  "Output Workspace",      paste0(getwd(), params$output_dir),
  "1. Focal Area Map",     file.path(params$output_dir, params$dir_focal_area_),
  "2. TECI Map", file.path(params$output_dir, params$dir_teci_map),
  "3. DIFA Table",file.path(params$output_dir, params$dir_difa_table),
  "4. Sampling Grid",file.path(params$output_dir, params$dir_sampling_grid),
  "Session Summary", "",
) %>% rbind(format_session_info_table())

analysis_log %>% kbl(caption = "Analysis Log", escape = FALSE) %>%
  kable_paper("hover", full_width = F )
```

# Summary

<!-- One paragraph overview on key findings-not more than 200 words. This section should pull out and present the key/primary indicators, or top contributing findings to the indicators measured. This section might be better written last. Mandatory for all modules -->

# Module brief description

<!-- A brief info (not more than 100 words) about the module and its objectives.Simplified to include only key info. Web page is required -->

An URL to the more detailed documentation of [Module Name].

# Input data

## Land-Use/Cover Map in `r params$inputs$t1` {.tabset}

### Land Use/Cover Map

```{r input-data, echo=FALSE}
# Add your code here to generate maps, charts, or tables for input data
prepare_lc_data(params$inputs$lc_t1_path,
                  year = params$inputs$t1,
                  lookup_table = read.csv(params$inputs$lulc_lut_path)) %>% plot_categorical_raster()
```

### Land Use/Cover Lookup Table

```{r Land Use/Cover Lookup Table, echo=FALSE}
read.csv(params$inputs$lulc_lut_path) %>% 
  kbl(caption = "Land Use/Cover Lookup Table", escape = FALSE) %>%
  kable_paper("hover", full_width = F )
```

<font size="1"> **\***Land-use/cover class that represents important habitat or refugia for the taxon of interests is assigned `FocalArea = 0` .</font size>


### Edge Contrast Matrix

```{r Edge Contrast Matrix, echo=FALSE}
contrast_table <- read.csv(params$inputs$contab_pat, skip = 2)
colnames(contrast_table) <- read.csv(params$inputs$lulc_lut_path) %>% rename(Value=1) %>% filter(!Value %in% 0) %>% pull(2)
rownames(contrast_table)<- read.csv(params$inputs$lulc_lut_path) %>% rename(Value=1) %>%  filter(!Value %in% 0) %>% pull(2)

contrast_table %>% round(digits = 3) %>% 
  kbl(caption = "Edge Contrast Matrix", escape = FALSE) %>%
  kable_paper("hover", full_width = F )
```

# Results

<!-- Brief explanation of how to interpret the presented data at the landscape level. -->

<!-- Standard text, mandatory for all LUMENS Module -->

## Focal Area Map

```{r focal_area, echo=FALSE}
fa <- file.path(params$output_dir, params$dir_focal_area) %>% rast() %>% terra::as.factor()

fill_scale <- scale_fill_manual(values = rev(c("0"= "#f9ffe3","1"= "darkgreen")), na.value = "white",
                                labels = c('Others', 'Focal Area'), na.translate = F )
                    
sampling_grid <- file.path(output_dir,params$dir_sampling_grid) %>% st_read()
ggplot() +
    geom_spatraster(data = fa) +
    geom_sf(data = sampling_grid, fill=NA)+
    coord_sf()+
    fill_scale +
    theme_bw() +
    theme(legend.position = "bottom", 
          legend.title = element_blank(), 
          legend.key = element_rect(colour='grey32'))+
   guides(fill = guide_legend(reverse=T))
```

## TECI Map

```{r teci_map, echo=FALSE}
teci_map <- file.path(params$output_dir, params$dir_teci_map) %>% rast() 
basemap<- fa %>% classify(cbind(0,1)) %>% as.factor()

ggplot() +
  geom_spatraster(data = basemap, show.legend = FALSE)+
  scale_fill_manual(name ="Basemap", values = c("1"="lightgrey"), na.value = "transparent")+
  ggnewscale::new_scale_fill()+
  geom_spatraster(data = teci_map, inherit.aes = FALSE) +
  scale_fill_viridis_c(name ="TECI", limits=c(0, 100),
    option = "H", na.value = "transparent")+
  theme_bw() +
  guides(colour=guide_legend(title = "TECI"))+
  theme(legend.position = "bottom")
```

## DIFA Plot

```{r key-results-maps, echo=FALSE}
# Create DIFA plot
ggplot(params$difa_table, aes(x = TECI, y = FocalArea, xend = 100, yend = 100)) +
    geom_area(alpha = 0.8) +
    labs(x = "DIFA", y = "Cumulative Focal Area (%)") +
    theme_bw() +
    labs(caption = paste("DIFA Score = ", params$difa_score))
```

------------------------------------------------------------------------

<!-- Mandatory closing statement for all module -->

<font size="1"> LUMENS is free software and comes with ABSOLUTELY NO WARRANTY. Users are responsible for the results generated. Results depend on the quality of the input data ("garbage in, garbage out") and may vary or be sensitive to the parameters used. Please report any problems encountered while using LUMENS as [a GitHub issue](https://github.com/icraf-indonesia/lumens-shiny/issues). Feedback and questions are welcome [Contact Us URL]. </font size>
