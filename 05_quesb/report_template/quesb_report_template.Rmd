---
title: "QuES-B Report"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    df_print: kable
params:
  start_time: NA
  end_time: NA
  output_dir: NA
  total_area: NA
  # Single time series parameters
  dir_teci_map: NA
  dir_focal_area_: NA
  dir_difa_table: NA
  difa_table: NA
  difa_score: NA
  # Two time series parameters
  dir_teci_map_t1: NA
  dir_teci_map_t2: NA
  dir_teci_difference: NA
  dir_teci_diff_category: NA
  dir_focal_area_t1: NA
  dir_focal_area_t2: NA
  dir_difa_table_t1: NA
  dir_difa_table_t2: NA
  difa_table_t1: NA
  difa_score_t1: NA
  difa_table_t2: NA
  difa_score_t2: NA
  # Common parameters
  dir_sampling_grid: NA
  inputs: NA
  session_log: NA
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_functions, include=FALSE, error=TRUE, warning=TRUE, message=TRUE}
helper_funct_a <- "05_quesb/rscript/ques_biodiv_functions.r"
helper_funct_b <- "../rscript/ques_biodiv_functions.r"

if(file.exists(helper_funct_a)){
  source(helper_funct_a)
} else {
  source(helper_funct_b)
}
```


```{r eval=FALSE, include=FALSE}
load("output/ques_b_1990_2000/output_parameters.rds")
params<-report_params
```

```{r load_libraries, include=FALSE}
check_and_install_packages(
  c(
    "dplyr",
    "ggplot2",
    "caTools",
    "terra",
    "sf",
    "stringr",
    "kableExtra",
    "tidyr",
    "tidyterra",
    "ggnewscale"
  )
)
```

```{r setup_analysis, include=FALSE}
# Determine if two time periods are provided
is_two_periods <- !is.null(params$dir_teci_map_t2) && !params$dir_teci_map_t2 %in% c("NA", NA)

cat("Value of params$dir_teci_map_t2:", params$dir_teci_map_t2, "\n")
cat("Is two periods:", is_two_periods, "\n")

```

<details>
<summary>Click here for Analysis Log</summary>

```{r analysis-log, echo=FALSE}
analysis_log <- tribble(
  ~Category,                   ~Details,
  "Analysis Start",            params$start_time,
  "Analysis End",              params$end_time,
  "Input Data and Parameters", "",
  "Landcover map T1",          params$inputs$lc_t1_path,
  "Year T1",                   as.character(params$inputs$t1)
)

# Add conditional rows for two periods
if (is_two_periods) {
  analysis_log <- analysis_log %>%
    add_row(Category = "Landcover map T2", Details = params$inputs$lc_t2_path) %>%
    add_row(Category = "Year T2", Details = as.character(params$inputs$t2))
}

# Continue with the rest of the input parameters
analysis_log <- analysis_log %>%
  add_row(Category = "Landcover lookup",       Details = params$inputs$lulc_lut_path) %>%
  add_row(Category = "Contrast table",         Details = params$inputs$contab_path) %>%
  add_row(Category = "NoData land-cover class", Details = as.character(params$inputs$raster.nodata)) %>%
  add_row(Category = "Number of sampling points (n)", Details = as.character(params$inputs$sampling_points)) %>%
  add_row(Category = "Moving window radius (metres)", Details = as.character(params$inputs$window_size)) %>%
  add_row(Category = "Moving window shape",   Details = as.character(params$inputs$window.shape)) %>%
  add_row(Category = "Fragstats config file", Details = params$inputs$fca_path) %>%
  add_row(Category = "Fragstats directory",   Details = params$inputs$fragstats_path) %>%
  add_row(Category = "Output Files",              Details = "") %>%
  add_row(Category = "Output Workspace",          Details = paste0(getwd(), params$output_dir))

# Add output files based on whether it's two periods or not
if (is_two_periods) {
  analysis_log <- analysis_log %>%
    add_row(Category = "Focal Area Map (t1)", Details = file.path(params$output_dir, params$dir_focal_area_t1)) %>%
    add_row(Category = "Focal Area Map (t2)", Details = file.path(params$output_dir, params$dir_focal_area_t2)) %>%
    add_row(Category = "TECI Map (t1)", Details = file.path(params$output_dir, params$dir_teci_map_t1)) %>%
    add_row(Category = "TECI Map (t2)", Details = file.path(params$output_dir, params$dir_teci_map_t2)) %>%
    add_row(Category = "TECI Difference Map", Details = file.path(params$output_dir, params$dir_teci_difference)) %>%
    add_row(Category = "DIFA Table (t1)", Details = file.path(params$output_dir, params$dir_difa_table_t1)) %>%
    add_row(Category = "DIFA Table (t2)", Details = file.path(params$output_dir, params$dir_difa_table_t2)) %>%
    add_row(Category = "Sampling Grid", Details = file.path(params$output_dir, params$dir_sampling_grid))
} else {
  analysis_log <- analysis_log %>%
    add_row(Category = "Focal Area Map", Details = file.path(params$output_dir, params$dir_focal_area_t1)) %>%
    add_row(Category = "TECI Map", Details = file.path(params$output_dir, params$dir_teci_map_t1)) %>%
    add_row(Category = "DIFA Table", Details = file.path(params$output_dir, params$dir_difa_table_t1)) %>%
    add_row(Category = "Sampling Grid", Details = file.path(params$output_dir, params$dir_sampling_grid))
}

# Add Session Summary
analysis_log <- analysis_log %>%
  add_row(Category = "Session Summary", Details = "")

# Append formatted session info
analysis_log <- rbind(analysis_log, format_session_info_table())

analysis_log %>% kbl(caption = "Analysis Log", escape = FALSE) %>%
  kable_paper("hover", full_width = F)
```

</details>

```{r check_focal_area, message=FALSE, warning=FALSE, include=FALSE}
# Read the land use/land cover lookup table
lut <- read.csv(params$inputs$lulc_lut_path)

# Load land cover maps
lc_t1_map <- prepare_lc_data(
  params$inputs$lc_t1_path,
  year = params$inputs$t1,
  lookup_table = lut)

NAflag(lc_t1_map) <- params$inputs$raster.nodata

# Extract the name of the focal area
focal_area_name <- lut %>%
  filter(.[[3]] == 1) %>% 
  pull(2)

# Calculate focal area estimates for time 1
focal_area_estimates_t1 <- lc_t1_map %>%
  suppressWarnings(aggregate(fact = c(100, 100) / res(.), fun = "modal")) %>%
  freq() %>%
  as_tibble() %>%
  rlang::set_names(c("layer", "Class", "Area")) %>%
  filter(Class %in% focal_area_name) %>%
  as.list()

fa_value_t1 <- focal_area_estimates_t1$Area %>% as.numeric()
total_area <- params$total_area %>% as.numeric()

if (is_two_periods) {
  lc_t2_map <- prepare_lc_data(
    params$inputs$lc_t2_path,
    year = params$inputs$t2,
    lookup_table = read.csv(params$inputs$lulc_lut_path)
  )
  NAflag(lc_t2_map) <- params$inputs$raster.nodata
  
  # Calculate focal area estimates for time 2
  focal_area_estimates_t2 <- lc_t2_map %>%
    suppressWarnings(aggregate(fact = c(100, 100) / res(.), fun = "modal")) %>%
    freq() %>%
    as_tibble() %>%
    rlang::set_names(c("layer", "Class", "Area")) %>%
    filter(Class %in% focal_area_name) %>%
    as.list()
  
  fa_value_t2 <- focal_area_estimates_t2$Area %>% as.numeric()
}

# Check if total_area is available
if (is.null(total_area) || is.na(total_area)) {
  warning("Total area is not defined. Calculating total area from lc_t1_map.")
  total_area <- lc_t1_map %>%
    suppressWarnings(aggregate(fact = c(100, 100) / res(.), fun = "modal")) %>%
    freq() %>%
    pull(count) %>%
    sum() %>%
    as.numeric()
}

```

# Summary

The focal area of interest is `r focal_area_estimates_t1$Class`.

It is estimated to cover:

- In `r params$inputs$t1`: `r scales::label_comma()(fa_value_t1)` hectares
`r if (is_two_periods) { paste("- In", params$inputs$t2, ":", scales::label_comma()(fa_value_t2), "hectares") }`

within the overall landscape, which spans `r scales::label_comma()(total_area)` hectares.

`r if (is_two_periods) {
  paste("The Degree of Integration of Focal Area (DIFA) Index for", params$inputs$t1, "is", params$difa_score_t1, "%, and for", params$inputs$t2, "is", params$difa_score_t2, "%.")
} else {
  paste("The Degree of Integration of Focal Area (DIFA) Index for this landscape is", params$difa_score, "%.")
}`

# Module brief description

-   QUES-B (Quantification of Ecosystem Services - Biodiversity) describes biodiversity conditions at the landscape scale with a focus on the composition and configuration of a focal area, which is carried out by calculating the Degree of Integration of Focal Area (DIFA) Index.

-   A focal area refers to the habitat of taxa of interest or areas that harbour rich biodiversity. Users can define these focal areas by selecting specific land cover classes that represent habitats of taxa of interest or areas known to support high biodiversity.

-   The Total Edge Contrast Index (TECI) map is a key component of QUES-B, illustrating the spatial distribution of focal area fragmentation and integration across the landscape by measuring the contrast between adjacent land cover types.

-   DIFA Index aims to quantify how well integrated a focal area is within a landscape, which indicates the landscape's capacity to conserve biodiversity.

-   QUES-B enables the comparison of the integration of focal areas across various zones or landscapes, assessment of temporal changes in habitat integration, and identification of vulnerable areas for conservation prioritisation.

# Input Data {.tabset}

## Land-Use/Cover Map in `r params$inputs$t1` 

```{r input-data-t1, echo=FALSE, message=FALSE, warning=FALSE}
plot_categorical_raster(lc_t1_map)
```

`r if (is_two_periods) { paste("## Land-Use/Cover Map in", params$inputs$t2) }`


```{r input-data-t2, echo=FALSE, message=FALSE, warning=FALSE, eval=is_two_periods}
plot_categorical_raster(lc_t2_map)
```

## Land Use/Cover Lookup Table

```{r land-use-lookup-table, echo=FALSE}
lut %>% 
  kbl(caption = "Land Use/Cover Lookup Table", escape = FALSE) %>%
   kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```

## Edge Contrast Matrix

A table defining contrast weights between different land use/cover types. Values range from 0 (identical) to 1 (maximum contrast).

```{r Edge Contrast Matrix, echo=FALSE}
contrast_table <- read.csv(params$inputs$contab_path, skip = 2)
colnames(contrast_table) <- read.csv(params$inputs$lulc_lut_path) %>% rename(Value=1) %>% pull(2)
rownames(contrast_table) <- read.csv(params$inputs$lulc_lut_path) %>% rename(Value=1) %>% pull(2)

contrast_table %>% round(digits = 3) %>% 
  kbl(caption = "Edge Contrast Matrix", escape = FALSE) %>%
  kable_paper() %>% 
  scroll_box(width = "100%", height = "400px")
```

# Results

## Focal Area Map {.tabset}

Focal area map illustrates the distribution of selected habitats of high biodiversity importance, that is `r focal_area_name` (shown in dark green) within the landscape. The map is overlaid with a sampling grid where each cell represents an area of `r report_params$inputs$window_size^2/10000` hectares.

### Focal Area Map in `r params$inputs$t1`

```{r focal_area_t1, echo=FALSE, message=FALSE, warning=FALSE}
fa_t1 <- file.path(params$output_dir, params$dir_focal_area_t1) %>% rast() %>% terra::as.factor()

fill_scale <- scale_fill_manual(values = rev(c("0"= "#f9ffe3","1"= "darkgreen")), na.value = "white",
                                labels = c('Others', 'Focal Area'), na.translate = F)

sampling_grid <- file.path(params$output_dir, params$dir_sampling_grid) %>% st_read(quiet=TRUE)
ggplot() +
    geom_spatraster(data = fa_t1) +
    geom_sf(data = sampling_grid, fill=NA) +
    coord_sf() +
    fill_scale +
    theme_bw() +
    theme(legend.position = "bottom", 
          legend.title = element_blank(), 
          legend.key = element_rect(colour='grey32')) +
    guides(fill = guide_legend(reverse=T))
```

`r if (is_two_periods) { paste("### Focal Area Map in", params$inputs$t2) }`

```{r focal_area_t2, echo=FALSE, message=FALSE, warning=FALSE, eval=is_two_periods}
fa_t2 <- file.path(params$output_dir, params$dir_focal_area_t2) %>% rast() %>% terra::as.factor()

ggplot() +
    geom_spatraster(data = fa_t2) +
    geom_sf(data = sampling_grid, fill=NA) +
    coord_sf() +
    fill_scale +
    theme_bw() +
    theme(legend.position = "bottom", 
          legend.title = element_blank(), 
          legend.key = element_rect(colour='grey32')) +
    guides(fill = guide_legend(reverse=T))
```

## TECI Map {.tabset}

TECI map illustrates the spatial distribution of Total Edge Contrast Index (TECI) values across the study area, representing `r focal_area_name` fragmentation and integration within the landscape.

### TECI Map in `r params$inputs$t1`

```{r teci_map_t1, echo=FALSE, message=FALSE, warning=FALSE}
teci_map_t1 <- file.path(params$output_dir, params$dir_teci_map_t1) %>% rast()
basemap_t1 <- fa_t1 %>% classify(cbind(0,1)) %>% as.factor()

ggplot() +
  geom_spatraster(data = basemap_t1, show.legend = FALSE) +
  scale_fill_manual(name ="Basemap", values = c("1"="lightgrey"), na.value = "transparent") +
  ggnewscale::new_scale_fill() +
  geom_spatraster(data = teci_map_t1, inherit.aes = FALSE) +
  scale_fill_viridis_c(name ="TECI", limits=c(0, 100), option = "H", na.value = "transparent") +
  theme_bw() +
  guides(colour=guide_legend(title = "TECI")) +
  theme(legend.position = "bottom")
```


`r if (is_two_periods) { paste("### TECI Map in", params$inputs$t2) }`

```{r teci_map_t2, echo=FALSE, message=FALSE, warning=FALSE, eval=is_two_periods}
teci_map_t2 <- file.path(params$output_dir, params$dir_teci_map_t2) %>% rast()
basemap_t2 <- fa_t2 %>% classify(cbind(0,1)) %>% as.factor()

ggplot() +
  geom_spatraster(data = basemap_t2, show.legend = FALSE) +
  scale_fill_manual(name ="Basemap", values = c("1"="lightgrey"), na.value = "transparent") +
  ggnewscale::new_scale_fill() +
  geom_spatraster(data = teci_map_t2, inherit.aes = FALSE) +
  scale_fill_viridis_c(name ="TECI", limits=c(0, 100), option = "H", na.value = "transparent") +
  theme_bw() +
  guides(colour=guide_legend(title = "TECI")) +
  theme(legend.position = "bottom")
```


`r if (is_two_periods) { "### TECI Difference Map" }`

```{r teci_difference_map, echo=FALSE, message=FALSE, warning=FALSE, eval=is_two_periods}
Sys.setenv(tidyterra.quiet = TRUE) 

teci_diff_map <- file.path(
  params$output_dir,
  params$dir_teci_diff_category) %>%
  rast()

# Create a data frame for the color palette
color_palette <- data.frame(
  value = 1:4,
  Description = c(
    "Fully integrated focal area",
    "Decrease in total edge contrast (integration)",
    "Increase in total edge contrast (segregation)",
    "Focal & edge area loss"
  ),
  colPal = c("darkolivegreen", "aquamarine3", "orange", "darkred")
)

# Create the main plot
ggplot() +
  geom_spatraster(data = teci_diff_map) +
  scale_fill_manual(
    values = color_palette$colPal,
    labels = color_palette$Description,
    name = "Focal and Edge Area \nChange Categories"
  ) +
  theme_minimal() +
  theme(
    legend.title =  element_text(size = 10),
    legend.text = element_text(size = 8),
    axis.title = element_text(size = 10)
  ) +
  labs(
    x = "Latitude",
    y = "Longitude")
```

## {-}

Lower TECI values, shown in darker blue colours, indicate well-integrated areas with minimal contrast between adjacent land cover types. Conversely, higher TECI values, depicted gradually in green, yellow, and ultimately red, represent more segregated areas with greater contrast between neighbouring land uses. The grey areas represent areas that are outside the dispersal radius of `r params$inputs$window_size` meters from the focal area.

## DIFA Plot {.tabset}

### DIFA Plot in `r params$inputs$t1`

```{r difa_plot_t1, echo=FALSE}
difa_table_t1 <- read.csv(file.path(params$output_dir, params$dir_difa_table_t1))

ggplot(difa_table_t1, aes(x = TECI, y = FocalArea, xend = 100, yend = 100)) +
  geom_area(alpha = 0.8) +
  labs(x = "TECI", y = "Cumulative Focal Area (%)", caption = paste("DIFA Score =", params$difa_score_t1, "%")) +
  theme_bw()
```

`r if (is_two_periods) { paste("### DIFA Plot in", params$inputs$t2) }`

```{r difa_plot_t2, echo=FALSE, eval=is_two_periods}
difa_table_t2 <- read.csv(file.path(params$output_dir, params$dir_difa_table_t2))

ggplot(difa_table_t2, aes(x = TECI, y = FocalArea,  xend = 100, yend = 100)) +
  geom_area(alpha = 0.8) +
  labs(x = "TECI", y = "Cumulative Focal Area (%)", caption = paste("DIFA Score =", params$difa_score_t2, "%")) +
  theme_bw()
```



`r if (is_two_periods) { "### DIFA Comparison Plot" }`

```{r difa_comparison_plot, echo=FALSE, eval=is_two_periods}
difa_table_t1$Time <- params$inputs$t1
difa_table_t2$Time <- params$inputs$t2

difa_combined <- bind_rows(difa_table_t1, difa_table_t2) %>% mutate(Time= as.factor(Time))

ggplot(difa_combined, aes(x = TECI, y = FocalArea, fill = Time, xend = 100, yend = 100)) +
  geom_area(alpha=0.6,  position = 'identity') +
  labs(x = "TECI", y = "Cumulative Focal Area (%)", color = "Time") +
  theme_bw()+ theme(legend.position = "bottom")
```

## {-}

The x-axis represents the Total Edge Contrast Index (TECI), while the y-axis shows the cumulative proportion of focal area. The curve depicts the relationship between habitat fragmentation (TECI) and habitat amount. The area under this curve determines the DIFA score, ranging from 0 to 100%. Higher scores indicate better habitat integration.

------------------------------------------------------------------------
<font size="1"> LUMENS is free software and comes with ABSOLUTELY NO WARRANTY. Users are responsible for the results generated. Results depend on the quality of the input data ("garbage in, garbage out") and may vary or be sensitive to the parameters used. Please report any problems encountered while using LUMENS as [a GitHub issue](https://github.com/icraf-indonesia/lumens-shiny/issues). Feedback and questions are welcome [Contact Us URL]. </font size>